<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <style>
        .center {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth__de.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
    <script type="text/javascript">
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        async function init() {
            const response = await fetch("/firebase-config.json")
            const firebaseConfig = await response.json();

            const app = firebase.initializeApp(firebaseConfig);
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);


            var uiConfig = {
                callbacks: {
                    signInSuccessWithAuthResult: function (authResult, redirectUrl) {
                        var user = authResult.user;
                        var credential = authResult.credential;
                        var isNewUser = authResult.additionalUserInfo.isNewUser;
                        var providerId = authResult.additionalUserInfo.providerId;
                        var operationType = authResult.operationType;

                        if (isNewUser) {//Email verification required for MFA
                            firebase.auth().currentUser.sendEmailVerification()
                                .then(() => {
                                    // Email verification sent!
                                    console.log("sent");
                                });
                        }
                        // Do something with the returned AuthResult.
                        // Return type determines whether we continue the redirect
                        // automatically or whether we leave that to developer to handle.
                        return false;
                    },
                    signInFailure: function (error) {
                        // Some unrecoverable error occurred during sign-in.
                        // Return a promise when error handling is completed and FirebaseUI
                        // will reset, clearing any UI. 
                        return handleUIError(error);
                    },
                    uiShown: function () {
                        // The widget is rendered.
                        // Hide the loader.
                        document.getElementById('loader').style.display = 'none';
                    }
                },
                // Query parameter name for mode.
                queryParameterForWidgetMode: 'mode',
                // Query parameter name for sign in success url.
                queryParameterForSignInSuccessUrl: 'signInSuccessUrl',
                signInFlow: 'redirect',
                signInSuccessUrl: '/auth',
                signInOptions: [
                    {
                        provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                        // Whether the display name should be displayed in the Sign Up page.
                        requireDisplayName: true
                    }
                ],
                tosUrl: '<your-tos-url>',
                privacyPolicyUrl: '<your-privacy-policy-url>'
            };

            var ui = new firebaseui.auth.AuthUI(firebase.auth());
            // The start method will wait until the DOM is loaded.
            ui.start('#firebaseui-auth-container', uiConfig);

            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    user.getIdToken().then(idToken => {
                        const csrfToken = getCookie('_csrf');
                        fetch("/sessionLogin", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `idToken=${idToken}&csrfToken=${csrfToken}`,
                        }).then((result)=>{
                            firebase.auth().signOut().then(()=>{
                                window.location.assign('/profile');
                            });
                        });
                        //return postIdTokenToSessionLogin('/sessionLogin', idToken, csrfToken);
                    });
            
                } else {
                    // User is signed out
                    //TODO abort
                }
            });
        }

        init();
    </script>
</head>

<body>
    <!-- The surrounding HTML is left untouched by FirebaseUI.
         Your app may use that space for branding, controls and other customizations.-->
    <h1 class="center">Welcome to My Awesome App</h1>
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading...</div>
    <div class="center" style="font-weight: bold;">
        <h3>Passwortanforderungen:</h3>
        <ui>
            <li>Mindestens 12 Zeichen</li>
            <li>Gro√ü- und Kleinbuchstaben</li>
            <li>Ziffern</li>
            <li>Sonderzeichen ^ $ * . [ ] { } ( ) ? " ! @ # % & / \ , &gt; &lt; ' : ; | _ ~ `</li>
        </ui>
    </div>
</body>

</html>