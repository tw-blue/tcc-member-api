<!DOCTYPE html>
<html>

<head>
    <title>Successful Login</title>
    <script src="https://www.gstatic.com/firebasejs/7.18/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18/firebase-auth.js"></script>
    <script type="text/javascript">
        let userPromise;
        async function init() {
            const response = await fetch("/firebase-config.json")
            const firebaseConfig = await response.json();

            const app = firebase.initializeApp(firebaseConfig);
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE);

            userPromise = new Promise((resolve, reject) => {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        resolve(user);
                    } else {
                        reject();
                    }
                });
            });
            return userPromise;
        };

        async function vote() {
            await userPromise;
            if (firebase.auth().currentUser) {
                try {
                    let team = document.getElementById("team").value;
                    const token = await firebase.auth().currentUser.getIdToken();
                    const response = await fetch("/vote", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            Authorization: `Bearer ${token}`
                        },
                        body: 'team=' + team,
                    });
                    if (response.ok) {
                        const text = await response.text();
                        window.alert(text);
                        window.location.reload();
                    }
                } catch (err) {
                    console.log(`Error when submitting  vote: ${err}`);
                    window.alert("Something went wrong... Please try again!");
                }
            } else {
                window.alert('User not signed in.');
            }
        }

        async function logout() {
            const response = await fetch("/sessionLogout", method = 'POST');

            if (response.ok) {
                window.alert("success");
            } else {
                window.alert("fail");
            };
        }

        async function promote() {
            const token = await firebase.auth().currentUser.getIdToken();
            const response = await fetch("/promote", {
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            if (response.ok) {
                firebase.auth().signOut().then(() => {
                    window.alert("success");
                    window.location.replace("/login");
                }).catch((error) => {
                    window.alert("fail");
                });
            }
        }

        async function demote() {
            const token = await firebase.auth().currentUser.getIdToken();
            const response = await fetch("/demote", {
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });
            if (response.ok) {
                firebase.auth().signOut().then(() => {
                    window.alert("success");
                    window.location.replace("/login");
                }).catch((error) => {
                    window.alert("fail");
                });
            }
        }

        init();
    </script>
</head>

<body>
    OK
    <label for="team">Team:</label>
    <input type="text" name="team" id="team">
    <button onclick="vote()">Vote</button>
    <button onclick="logout()">Logout</button>
    <button onclick="promote()">Promote</button>
    <button onclick="demote()">Demote</button>
</body>

</html>